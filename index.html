<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <!-- 这一行让App在手机上全屏运行，禁止缩放 -->
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, viewport-fit=cover">
    
    <!-- PWA 配置开始 -->
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
    <meta name="theme-color" content="#0a0a0a">
    <link rel="apple-touch-icon" href="icon.png"> <!-- 记得上传 icon.png -->
    <link rel="icon" type="image/png" href="icon.png">
    <!-- PWA 配置结束 -->

    <title>空 | KŪ</title>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Noto+Serif+SC:wght@300;500;700&family=Zen+Maru+Gothic:wght@400;700&display=swap');

        :root {
            --text: #ffffff;
            --glass: rgba(255, 255, 255, 0.08);
        }

        body, html {
            margin: 0; padding: 0; width: 100%; height: 100%;
            background-color: #0a0a0a;
            color: var(--text);
            font-family: 'Noto Serif SC', serif;
            overflow: hidden;
            -webkit-tap-highlight-color: transparent;
            /* 禁止长按选中 */
            user-select: none;
            -webkit-user-select: none;
        }

        /* 背景 */
        #bg-canvas {
            position: absolute; top: 0; left: 0; width: 100%; height: 100%;
            z-index: 0; filter: blur(80px) saturate(140%);
            transition: opacity 1s ease;
        }
        #base-layer {
            position: absolute; top: 0; left: 0; width: 100%; height: 100%;
            z-index: -1; background: #0a0a0a; transition: background 1.5s ease;
        }

        #app {
            position: relative; z-index: 10; width: 100%; height: 100%;
            display: flex; flex-direction: column;
            padding-bottom: env(safe-area-inset-bottom);
        }

        /* 导航 */
        .navbar { padding-top: 60px; display: flex; justify-content: center; gap: 60px; z-index: 100; }
        .nav-item { font-size: 15px; color: rgba(255,255,255,0.5); cursor: pointer; padding: 10px; transition: 0.4s; letter-spacing: 3px; }
        .nav-item.active { color: #fff; font-weight: 600; text-shadow: 0 0 20px rgba(255,255,255,0.4); }

        /* 视图 */
        .viewport { flex: 1; position: relative; width: 100%; }
        .page { position: absolute; top:0; left:0; width: 100%; height: 100%; display: flex; flex-direction: column; align-items: center; justify-content: center; opacity: 0; pointer-events: none; transition: opacity 0.6s ease; }
        .page.active { opacity: 1; pointer-events: auto; }

        /* === 释放页 === */
        .release-container { width: 100%; height: 100%; display: flex; flex-direction: column; align-items: center; justify-content: center; position: relative; }
        .input-box { width: 85%; max-width: 400px; position: relative; z-index: 50; transition: transform 0.6s cubic-bezier(0.2, 0.8, 0.2, 1); }
        textarea {
            width: 100%; height: 180px; background: rgba(255,255,255,0.03); border: none; border-radius: 20px;
            color: #fff; font-family: 'Noto Serif SC', serif; font-size: 20px; line-height: 1.8; text-align: center; resize: none; outline: none;
            padding: 30px 20px; margin-bottom: 10px; transition: all 0.3s; pointer-events: auto; backdrop-filter: blur(20px);
            user-select: text; -webkit-user-select: text; /* 允许输入框选中 */
        }
        textarea:focus { background: rgba(255,255,255,0.06); box-shadow: 0 10px 40px rgba(0,0,0,0.1); }
        textarea::placeholder { color: rgba(255,255,255,0.2); font-style: italic; font-size: 14px; letter-spacing: 1px; }
        
        .privacy-hint { font-size: 10px; color: rgba(255,255,255,0.2); text-align: center; margin-bottom: 40px; letter-spacing: 1px; font-family: sans-serif; }

        .btn-orb {
            width: 70px; height: 70px; border-radius: 50%;
            background: radial-gradient(circle at 30% 30%, #fff, rgba(255,255,255,0.3));
            box-shadow: 0 0 60px rgba(255,255,255,0.4); cursor: pointer; position: relative; z-index: 100;
            transition: transform 0.3s; margin-bottom: 80px;
        }
        .btn-orb:active { transform: scale(0.9); opacity: 0.9; }

        /* 结果卡片 */
        .card-layer { position: absolute; top: 0; left: 0; width: 100%; height: 100%; display: flex; align-items: center; justify-content: center; pointer-events: none; z-index: 200; opacity: 0; transition: 0.5s; }
        .card-layer.show { opacity: 1; pointer-events: auto; }
        .soul-card {
            width: 82%; max-width: 340px; padding: 50px 30px; background: rgba(20, 20, 20, 0.9); border: 1px solid rgba(255,255,255,0.15);
            box-shadow: 0 40px 100px rgba(0,0,0,0.6); text-align: center; border-radius: 16px; backdrop-filter: blur(40px);
            transform: translateY(20px); transition: 0.6s cubic-bezier(0.2, 1, 0.3, 1); color: #fff;
        }
        .card-layer.show .soul-card { transform: translateY(0); }
        .card-time { font-size: 10px; opacity: 0.4; letter-spacing: 2px; margin-bottom: 20px; font-family: 'Zen Maru Gothic', sans-serif; }
        .card-content { font-size: 19px; line-height: 1.8; margin-bottom: 40px; font-weight: 400; opacity: 0.95; }
        .card-btn { font-size: 12px; color: rgba(255,255,255,0.7); border: 1px solid rgba(255,255,255,0.3); padding: 10px 28px; border-radius: 30px; display: inline-block; cursor: pointer; transition: 0.2s; }
        .card-btn:hover { border-color: #fff; color: #fff; background: rgba(255,255,255,0.1); }

        /* 底部主题 */
        .theme-switcher { position: absolute; bottom: 50px; display: flex; gap: 25px; z-index: 50; background: rgba(255,255,255,0.05); padding: 10px 20px; border-radius: 30px; backdrop-filter: blur(10px); }
        .t-dot { width: 10px; height: 10px; border-radius: 50%; cursor: pointer; transition: 0.3s; opacity: 0.6; }
        .t-dot.active { transform: scale(1.4); opacity: 1; box-shadow: 0 0 10px currentColor; }
        .dot-void { background: #a1a1aa; color: #a1a1aa; } .dot-dream { background: #fbbf24; color: #fbbf24; } .dot-mist { background: #99f6e4; color: #99f6e4; }

        /* 冥想页 */
        .meditate-container { display: flex; flex-direction: column; align-items: center; width: 100%; }
        .breath-ring { width: 240px; height: 240px; border: 1px solid rgba(255,255,255,0.1); border-radius: 50%; display: flex; align-items: center; justify-content: center; position: relative; margin-top: 30px; cursor: pointer; }
        .breath-core { width: 60px; height: 60px; background: #fff; border-radius: 50%; opacity: 0.9; filter: blur(20px); transition: transform 0.1s linear; box-shadow: 0 0 50px rgba(255,255,255,0.3); }
        .timer-display { position: absolute; font-size: 18px; font-family: 'Zen Maru Gothic', sans-serif; color: rgba(255,255,255,0.6); pointer-events: none; }
        .guide-text { margin-top: 50px; font-size: 14px; letter-spacing: 4px; color: rgba(255,255,255,0.7); }
        
        .mode-selector { display: flex; gap: 40px; margin-top: 60px; }
        .mode-btn { font-size: 12px; color: rgba(255,255,255,0.4); cursor: pointer; padding: 6px 12px; transition: 0.3s; letter-spacing: 1px; }
        .mode-btn.active { color: #fff; border-bottom: 1px solid #fff; }

        /* 音效选择器 (新增) */
        .sound-selector { display: flex; gap: 30px; margin-top: 30px; }
        .sound-btn { font-size: 12px; color: rgba(255,255,255,0.4); cursor: pointer; padding: 8px 16px; border-radius: 20px; border: 1px solid transparent; transition: 0.3s; letter-spacing: 1px; }
        .sound-btn:hover { background: rgba(255,255,255,0.05); }
        .sound-btn.active { color: #fff; border-color: rgba(255,255,255,0.3); background: rgba(255,255,255,0.1); }

        #fx-canvas { position: absolute; top: 0; left: 0; width: 100%; height: 100%; pointer-events: none; z-index: 20; }
        .creator-sign { position: absolute; bottom: 15px; width: 100%; text-align: center; font-size: 10px; color: rgba(255,255,255,0.2); letter-spacing: 1px; font-family: sans-serif; pointer-events: none; z-index: 5; }
    </style>
</head>
<body>

    <div id="base-layer"></div>
    <canvas id="bg-canvas"></canvas>
    <canvas id="fx-canvas"></canvas>

    <div id="app">
        <div class="navbar">
            <div class="nav-item active" onclick="switchTab('release')">释 放</div>
            <div class="nav-item" onclick="switchTab('meditate')">冥 想</div>
        </div>

        <div class="viewport">
            <!-- 释放页 -->
            <div class="page active" id="page-release">
                <div class="release-container">
                    <div class="input-box" id="input-ui">
                        <textarea id="mood-input" placeholder=""></textarea>
                        <div class="privacy-hint">文字仅在本地粉碎，不会上传云端</div>
                    </div>
                    <div class="btn-orb" id="btn-ui" onclick="triggerRelease()"></div>
                    
                    <div class="theme-switcher" id="theme-ui">
                        <div class="t-dot dot-void active" onclick="setTheme('void')"></div>
                        <div class="t-dot dot-dream" onclick="setTheme('dream')"></div>
                        <div class="t-dot dot-mist" onclick="setTheme('mist')"></div>
                    </div>
                </div>

                <div class="card-layer" id="card-layer">
                    <div style="position:absolute;width:100%;height:100%;" onclick="resetCard()"></div>
                    <div class="soul-card">
                        <div class="card-time" id="card-time">00:00</div>
                        <div class="card-content" id="card-text"></div>
                        <div class="card-btn" onclick="resetCard()">收下能量</div>
                    </div>
                </div>
            </div>

            <!-- 冥想页 -->
            <div class="page" id="page-meditate">
                <div class="meditate-container">
                    <div class="breath-ring" id="breath-trigger">
                        <div class="breath-core" id="breath-visual"></div>
                        <div class="timer-display" id="timer-text"></div>
                    </div>
                    <div class="guide-text" id="guide-text">点击光环开始</div>
                    
                    <div class="mode-selector">
                        <div class="mode-btn active" onclick="setBreathMode('sleep')">安睡</div>
                        <div class="mode-btn" onclick="setBreathMode('focus')">专注</div>
                        <div class="mode-btn" onclick="setBreathMode('balance')">平衡</div>
                    </div>

                    <div class="sound-selector">
                        <div class="sound-btn active" onclick="setSound('ambient')">灵</div>
                        <div class="sound-btn" onclick="setSound('rain')">雨</div>
                        <div class="sound-btn" onclick="setSound('waves')">潮</div>
                    </div>
                </div>
            </div>
        </div>
        
        <div class="creator-sign">Created by 你的名字</div>
    </div>

<script>
    /* ==============================================
       1. 智能文案引擎 (Smart Sentiment Engine)
       ============================================== */
    const Library = {
        placeholders: [
            "最近有什么放不下的事？",
            "那些没说出口的话，留在这里吧...",
            "这里很安全，可以稍微脆弱一会儿。",
            "脑海里那个关不掉的声音在说什么？"
        ],
        categories: {
            guilt: ["别责怪自己，你只是太累了。","不必强迫自己原谅，把伤口交给时间。","你不需要向任何人证明你的疲惫。","除了你自己，其实没有人在审判你。"],
            anxious: ["焦虑是想要控制不可控的未来，回到当下。","这一关很难，但你会跨过去的。","松一口气吧，世界不会因为你停下一秒而崩塌。","松开手，沙子才不会漏得那么快。"],
            lonely: ["今晚的月亮是为你亮的，世界依然爱着你。","拥抱一下那个在心里哭泣的小孩吧。","那些让你痛苦的缝隙，也是光照进来的地方。","你不是一座孤岛，这一刻，我在。"],
            angry: ["水至清则无鱼，放过自己，也放过万物。","合不来的人就像不合脚的鞋，脱掉它。","在这个时刻，你不需要取悦任何人。","把情绪倒出来，然后转身离开。"],
            tired: ["去洗个热水澡，把这一身疲惫冲掉。","被窝是绝对安全的堡垒，躲进去吧。","这一分钟过去后，它就变成了历史。","没事了，都过去了。好好睡一觉。"],
            general: ["你比你想象的更坚韧。","生活是旷野，不是轨道。","我看见了你的努力，这就足够了。"]
        },
        getAffirmation(text) {
            const t = text.toLowerCase();
            if (t.match(/累|困|死|想睡|疲|倦/)) return this.getRandom('tired');
            if (t.match(/恨|气|烦|滚|讨厌|凭什么/)) return this.getRandom('angry');
            if (t.match(/错|对不起|不好|失败|差|笨|蠢/)) return this.getRandom('guilt');
            if (t.match(/怕|慌|担心|怎么办|未来|钱|工作/)) return this.getRandom('anxious');
            if (t.match(/孤独|没人|爱|分手|想念|他|她/)) return this.getRandom('lonely');
            const hour = new Date().getHours();
            if (hour >= 0 && hour < 4) return "深夜是灵魂的避难所，把重担放下吧。";
            return this.getRandom('general');
        },
        getRandom(category) {
            const pool = this.categories[category];
            return pool[Math.floor(Math.random() * pool.length)];
        }
    };

    /* ==============================================
       2. 极光背景与交互
       ============================================== */
    const bgCanvas = document.getElementById('bg-canvas');
    const baseLayer = document.getElementById('base-layer');
    const bgCtx = bgCanvas.getContext('2d');
    let bgW, bgH, orbs = [], mouse = { x: -500, y: -500 };
    let currentPalette = 'void'; 

    const palettes = {
        void: { colors: ['#525252', '#737373', '#262626'], bg: '#0a0a0a' },
        dream: { colors: ['#fb923c', '#e879f9', '#f43f5e'], bg: '#1c1010' },
        mist: { colors: ['#5eead4', '#94a3b8', '#0f766e'], bg: '#0f1515' }
    };

    class Orb {
        constructor() { this.init(); }
        init() {
            this.x = Math.random() * bgW;
            this.y = Math.random() * bgH;
            this.r = Math.random() * 250 + 150; 
            this.vx = (Math.random() - 0.5) * 0.3;
            this.vy = (Math.random() - 0.5) * 0.3;
            this.updateColor();
        }
        updateColor() {
            const p = palettes[currentPalette].colors;
            this.color = p[Math.floor(Math.random() * p.length)];
        }
        update() {
            this.x += this.vx; this.y += this.vy;
            const dx = mouse.x - this.x; const dy = mouse.y - this.y;
            const dist = Math.sqrt(dx*dx + dy*dy);
            if(dist < 400) {
                const force = (400 - dist) / 400;
                this.x -= dx * force * 0.03; this.y -= dy * force * 0.03;
            }
            if(this.x < -this.r) this.x = bgW + this.r;
            if(this.x > bgW + this.r) this.x = -this.r;
            if(this.y < -this.r) this.y = bgH + this.r;
            if(this.y > bgH + this.r) this.y = -this.r;
        }
        draw() {
            bgCtx.beginPath();
            const g = bgCtx.createRadialGradient(this.x, this.y, 0, this.x, this.y, this.r);
            g.addColorStop(0, this.color); g.addColorStop(1, 'transparent');
            bgCtx.fillStyle = g; bgCtx.globalAlpha = 0.5;
            bgCtx.arc(this.x, this.y, this.r, 0, Math.PI*2); bgCtx.fill();
        }
    }

    function initBg() { bgW = window.innerWidth; bgH = window.innerHeight; bgCanvas.width = bgW; bgCanvas.height = bgH; orbs = []; for(let i=0; i<6; i++) orbs.push(new Orb()); }
    function animateBg() { bgCtx.clearRect(0, 0, bgW, bgH); bgCtx.globalCompositeOperation = 'screen'; orbs.forEach(o => { o.update(); o.draw(); }); requestAnimationFrame(animateBg); }
    
    window.addEventListener('mousemove', e => { mouse.x = e.clientX; mouse.y = e.clientY; });
    window.addEventListener('touchmove', e => { mouse.x = e.touches[0].clientX; mouse.y = e.touches[0].clientY; });
    window.addEventListener('resize', initBg);
    initBg(); animateBg();

    /* ==============================================
       3. 音频与逻辑
       ============================================== */
    const AudioEngine = {
        ctx: null, activeNodes: [],
        init() { try { if (!this.ctx) this.ctx = new (window.AudioContext||window.webkitAudioContext)(); if (this.ctx.state === 'suspended') this.ctx.resume(); return true; } catch(e){return false;} },
        stopAll() { this.activeNodes.forEach(n => { try{n.stop(); n.disconnect();}catch(e){} }); this.activeNodes = []; },
        playShatter() {
            if(!this.init()) return;
            try {
                const t=this.ctx.currentTime; const b=this.ctx.createBuffer(1,this.ctx.sampleRate,this.ctx.sampleRate);
                const d=b.getChannelData(0); for(let i=0;i<d.length;i++) d[i]=Math.random()*2-1;
                const s=this.ctx.createBufferSource(); s.buffer=b;
                const f=this.ctx.createBiquadFilter(); f.type='highpass'; f.frequency.value=1500;
                const g=this.ctx.createGain(); g.gain.setValueAtTime(0.5,t); g.gain.exponentialRampToValueAtTime(0.01,t+0.1);
                s.connect(f); f.connect(g); g.connect(this.ctx.destination); s.start(t);
                [2000,4000].forEach((fr,i)=>{
                    const o=this.ctx.createOscillator(); const og=this.ctx.createGain();
                    o.frequency.value=fr; og.gain.setValueAtTime(0.05,t); og.gain.exponentialRampToValueAtTime(0.001,t+0.15);
                    o.connect(og); og.connect(this.ctx.destination); o.start(t); o.stop(t+0.2);
                });
            } catch(e){}
        },
        playAmbient() { if(!this.init()) return; const o=this.ctx.createOscillator(); const g=this.ctx.createGain(); o.frequency.value=110; g.gain.value=0.15; o.connect(g); g.connect(this.ctx.destination); o.start(); this.activeNodes.push(o); },
        playRain() { if(!this.init()) return; const b=this.ctx.createBuffer(1,2*this.ctx.sampleRate,this.ctx.sampleRate); const d=b.getChannelData(0); for(let i=0;i<d.length;i++) d[i]=(Math.random()*2-1)*0.1; const s=this.ctx.createBufferSource(); s.buffer=b; s.loop=true; const g=this.ctx.createGain(); g.gain.value=0.2; s.connect(g); g.connect(this.ctx.destination); s.start(); this.activeNodes.push(s); },
        playWaves() { if(!this.init()) return; const b=this.ctx.createBuffer(1,2*this.ctx.sampleRate,this.ctx.sampleRate); const d=b.getChannelData(0); for(let i=0;i<d.length;i++) d[i]=Math.random()*2-1; const s=this.ctx.createBufferSource(); s.buffer=b; s.loop=true; const f=this.ctx.createBiquadFilter(); f.type='lowpass'; f.frequency.value=400; const g=this.ctx.createGain(); g.gain.value=0.15; const lfo=this.ctx.createOscillator(); lfo.frequency.value=0.1; const lg=this.ctx.createGain(); lg.gain.value=300; lfo.connect(lg); lg.connect(f.frequency); lfo.start(); s.connect(f); f.connect(g); g.connect(this.ctx.destination); s.start(); this.activeNodes=[s,l]; },
        playBell() { if(!this.init())return; const t=this.ctx.currentTime; const o=this.ctx.createOscillator(); const g=this.ctx.createGain(); o.frequency.value=200; g.gain.setValueAtTime(0.2,t); g.gain.exponentialRampToValueAtTime(0.001,t+4); o.connect(g); g.connect(this.ctx.destination); o.start(t); o.stop(t+4); }
    };
    ['click','touchstart'].forEach(e=>document.addEventListener(e,()=>AudioEngine.init(),{once:true}));

    const fxCanvas = document.getElementById('fx-canvas'); const fxCtx = fxCanvas.getContext('2d'); let fxW, fxH, particles = [];
    function initFx() { fxW=window.innerWidth; fxH=window.innerHeight; fxCanvas.width=fxW; fxCanvas.height=fxH; }
    window.addEventListener('resize', initFx); initFx();
    function spawnParticles(x, y, color) { AudioEngine.playShatter(); if(navigator.vibrate) navigator.vibrate(40); for(let i=0; i<50; i++) { const a=Math.random()*Math.PI*2; const s=Math.random()*8+2; particles.push({x:x, y:y, vx:Math.cos(a)*s, vy:Math.sin(a)*s, life:1, decay:Math.random()*0.02+0.01, color:color||'#fff', size:Math.random()*3+1}); } }
    function animateFx() { fxCtx.clearRect(0,0,fxW,fxH); for(let i=particles.length-1; i>=0; i--) { let p=particles[i]; p.x+=p.vx; p.y+=p.vy; p.vx*=0.94; p.vy*=0.94; p.life-=p.decay; fxCtx.globalAlpha=p.life; fxCtx.fillStyle=p.color; fxCtx.beginPath(); fxCtx.arc(p.x, p.y, p.size, 0, Math.PI*2); fxCtx.fill(); if(p.life<=0) particles.splice(i,1); } requestAnimationFrame(animateFx); }
    animateFx();

    /* UI Logic */
    const ui = {
        input: document.getElementById('mood-input'),
        inputUi: document.getElementById('input-ui'),
        btnUi: document.getElementById('btn-ui'),
        themeUi: document.getElementById('theme-ui'),
        cardLayer: document.getElementById('card-layer'),
        cardText: document.getElementById('card-text'),
        cardTime: document.getElementById('card-time'),
        navs: document.querySelectorAll('.nav-item'),
        pages: [document.getElementById('page-release'), document.getElementById('page-meditate')]
    };

    ui.input.placeholder = Library.placeholders[Math.floor(Math.random()*Library.placeholders.length)];
    window.setTheme = (theme) => { currentPalette = theme; baseLayer.style.background = palettes[theme].bg; orbs.forEach(o => o.updateColor()); document.querySelectorAll('.t-dot').forEach(d => d.classList.remove('active')); event.target.classList.add('active'); };

    window.triggerRelease = () => {
        const text = ui.input.value.trim();
        if(!text) return;
        const rect = document.getElementById('btn-ui').getBoundingClientRect();
        let pColor = currentPalette==='dream' ? '#ffccff' : (currentPalette==='mist' ? '#ccfffa' : '#fff');
        spawnParticles(rect.left+35, rect.top+35, pColor);

        ui.inputUi.style.opacity = 0; ui.inputUi.style.transform = 'scale(0.95)'; ui.inputUi.style.pointerEvents = 'none';
        ui.btnUi.style.opacity = 0; ui.btnUi.style.transform = 'scale(0)'; ui.themeUi.style.opacity = 0;

        ui.cardText.innerText = Library.getAffirmation(text);
        const now = new Date();
        ui.cardTime.innerText = `${now.getHours()}:${String(now.getMinutes()).padStart(2,'0')}`;
        setTimeout(() => ui.cardLayer.classList.add('show'), 500);
    };

    window.resetCard = () => {
        ui.cardLayer.classList.remove('show');
        setTimeout(() => {
            ui.input.value = '';
            ui.input.placeholder = Library.placeholders[Math.floor(Math.random()*Library.placeholders.length)];
            ui.inputUi.style.opacity = 1; ui.inputUi.style.transform = 'scale(1)'; ui.inputUi.style.pointerEvents = 'auto';
            ui.btnUi.style.opacity = 1; ui.btnUi.style.transform = 'scale(1)';
            ui.themeUi.style.opacity = 0.8;
        }, 500);
    };

    window.switchTab = (t) => {
        ui.navs.forEach(n => n.classList.remove('active')); ui.pages.forEach(p => p.classList.remove('active'));
        if(t === 'release') {
            ui.navs[0].classList.add('active'); ui.pages[0].classList.add('active'); stopMeditation();
            const theme = document.querySelector('.t-dot.active').getAttribute('onclick').match(/'(\w+)'/)[1]; window.setTheme(theme);
        } else {
            ui.navs[1].classList.add('active'); ui.pages[1].classList.add('active'); baseLayer.style.background = '#0a0a0a'; currentPalette = 'void'; orbs.forEach(o => o.updateColor());
        }
    };

    let currentSound='ambient'; let isMeditating=false; let breathTimer=null;
    const visual=document.getElementById('breath-visual'); const guide=document.getElementById('guide-text'); const timerText=document.getElementById('timer-text'); const trigger=document.getElementById('breath-trigger');

    window.setSound = (s) => {
        currentSound = s; document.querySelectorAll('.sound-btn').forEach(b => b.classList.remove('active')); event.target.classList.add('active');
        if(isMeditating) { AudioEngine.stopAll(); playSound(s); }
    };
    function playSound(s) { if(s==='ambient') AudioEngine.playAmbient(); else if(s==='rain') AudioEngine.playRain(); else if(s==='waves') AudioEngine.playWaves(); }

    trigger.addEventListener('click', () => isMeditating ? stopMeditation() : startMeditation());
    function startMeditation() { isMeditating=true; playSound(currentSound); AudioEngine.playBell(); guide.innerText="吸 气"; runBreathCycle(); }
    function stopMeditation() { isMeditating=false; clearTimeout(breathTimer); AudioEngine.stopAll(); visual.style.transform='scale(0.5)'; guide.innerText="点击光环开始"; timerText.innerText=""; }
    
    function startCount(d) { let l=d; timerText.innerText=l; const i=setInterval(()=>{ l--; if(l>0 && isMeditating) timerText.innerText=l; else clearInterval(i); },1000); }
    function runBreathCycle() {
        if(!isMeditating) return;
        let stages=[];
        if(breathMode==='sleep') stages=[{t:'吸 气',s:4,sc:3.5,o:0.5},{t:'屏 息',s:7,sc:3.5,o:0.5},{t:'呼 气',s:8,sc:1,o:0.9}];
        else if(breathMode==='focus') stages=[{t:'吸 气',s:4,sc:3.5,o:0.5},{t:'屏 息',s:4,sc:3.5,o:0.5},{t:'呼 气',s:4,sc:1,o:0.9},{t:'屏 息',s:4,sc:1,o:0.9}];
        else stages=[{t:'吸 气',s:5.5,sc:3.5,o:0.5},{t:'呼 气',s:5.5,sc:1,o:0.9}];
        let idx=0;
        function next() {
            if(!isMeditating) return; const st=stages[idx];
            guide.innerText=st.t; startCount(Math.ceil(st.s));
            visual.style.transition=`transform ${st.s}s linear, opacity ${st.s}s`;
            visual.style.transform=`scale(${st.sc})`; visual.style.opacity=st.o;
            breathTimer=setTimeout(()=>{ idx=(idx+1)%stages.length; next(); },st.s*1000);
        }
        next();
    }
</script>
</body>
</html>
